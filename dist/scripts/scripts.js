"use strict";var app=angular.module("popmap",["ui.router","snap","ngAnimate","ngMap","ui.bootstrap","colorpicker.module"]);angular.module("popmap").config(["$stateProvider","$urlRouterProvider",function(n,t){t.when("/dashboard","/dashboard/home"),t.otherwise("/login"),n.state("base",{"abstract":!0,url:"",templateUrl:"views/base.html"}).state("login",{url:"/login",parent:"base",templateUrl:"views/login.html",controller:"LoginCtrl"}).state("dashboard",{url:"/dashboard",parent:"base",templateUrl:"views/dashboard.html",controller:"DashboardCtrl"}).state("home",{url:"/home",parent:"dashboard",templateUrl:"views/dashboard/home.html"}).state("map",{url:"/map",parent:"dashboard",templateUrl:"views/dashboard/map.html"}).state("edit",{url:"/edit",parent:"dashboard",templateUrl:"views/dashboard/edit.html"}).state("editpop",{url:"/edit/pop/{id}",parent:"dashboard",templateUrl:"views/dashboard/edit/pop.html"}).state("newpop",{url:"/edit/pops/new",parent:"dashboard",templateUrl:"views/dashboard/edit/pop.html"}).state("editconnection",{url:"/edit/connection/{id}",parent:"dashboard",templateUrl:"views/dashboard/edit/connection.html"}).state("newconnection",{url:"/edit/connections/new",parent:"dashboard",templateUrl:"views/dashboard/edit/connection.html"})}]),angular.module("popmap").service("pops",["$q",function(n){var t=this;t.pops={ny:{"short":"NY",name:"New York",address:"Switch and Data - 111 8th Ave, New York, NY 10011",color:"52779a"},dc:{"short":"DC",name:"Washington",address:"Equinix, Cage 1010 - 21715 Filigree Ct., Ashburn VA 20147",color:"aaaaaa"},atl:{"short":"ATL",name:"Atlanta",address:"UseNetServer Fourth Floor - 56 Marietta St., Atlanta, GA 30303",color:"cc223c"},dal:{"short":"DAL",name:"Dallas",address:'Dallas,"1950 Stemmons Frwy"',color:"0972b4"},la:{"short":"LA",name:"Los Angeles",address:"One Wilshire Bldg., 11th Fl, Cage C1111 - 624 S. Grand Ave, Los Angeles, CA 90017",color:"ffbc01"},chi:{"short":"CHI",name:"Chicago",address:"Equinix - 350 E Cermak Rd, Chicago, IL 60616",color:"4ab9e6"},sea:{"short":"SEA",name:"Seattle",address:"2001 Sixth Ave, Seattle WA, 98121",color:"69be3f"},mia:{"short":"MIA",name:"Miami",address:"50 Northeast 9th Street, Miami, FL",color:"f25e18"}},t.connections={"ny-dc":["ny","dc"],"dc-atl":["dc","atl"],"atl-mia":["atl","mia"],"atl-dal":["atl","dal"],"dal-mia":["dal","mia"],"dal-la":["dal","la"],"la-sea":["la","sea"],"sea-chi":["sea","chi"],"chi-ny":["chi","ny"]},this.getPops=function(){return n(function(n,e){n(t.pops)})},this.getPop=function(e){return n(function(n,o){t.pops[e]?n(t.pops[e]):o()})},this.savePop=function(e,o){return n(function(n,i){e?(t.pops[e]=o,n(o)):i()})},this.deletePop=function(e){return n(function(o,i){if(t.pops[e]){var a=n.all(null);return a=a.then(function(){angular.forEach(t.connections,function(o,i){a=a.then(function(){return n(function(n){o&&o.indexOf(e)>-1?t.deleteConnection(i).then(n):n()})})})}),a.then(function(){delete t.pops[e],o()})}i()})},this.getConnections=function(){return n(function(n,o){e(t.connections).then(function(t){n(t)})})},this.getConnection=function(o){return n(function(n,i){if(t.connections[o]){var a={};return a[o]=t.connections[o],e(a).then(function(t){n(t[o])})}i()})},this.saveConnection=function(e,o,i){return n(function(n,a){e?t.deleteConnection(e).then(function(){t.connections[o+"-"+i]=[o,i],n(t.connections[o+"-"+i])}):a()})},this.deleteConnection=function(e){return n(function(n,o){e?(delete t.connections[e],n()):o()})};var e=function(e){if(!e)var e=t.connections;var o={};return t.getPops().then(function(t){var i=n.all(null);return angular.forEach(e,function(e,a){i=i.then(function(){return n(function(n,i){t[e[0]]&&t[e[1]]?(t[e[0]].id=e[0],t[e[1]].id=e[1],o[a]={id:a,start:t[e[0]],finish:t[e[1]]},n()):n()})})}),i.then(function(){return n(function(n){n(o)})})})}}]),angular.module("popmap").service("geocoder",["$q","$timeout",function(n,t){var e=this,o=new google.maps.Geocoder,i=0,a=10;e.getLocation=function(t){return e.geocode({address:t}).then(function(e){return n(function(n,o){var i=e[0].geometry.location;i.address=e[0].formatted_address||t,i.asTyped=t,i.zip=e[0].address_components[0],i.city=e[0].address_components[1],i.state=e[0].address_components[2],n(i)})},function(){return n(function(n,t){t()})})},e.getAddress=function(t){return e.geocode({location:t}).then(function(e){return n(function(n,o){e[1]?(t.address=e[1].formatted_address,t.zip=e[1].address_components[0],t.city=e[1].address_components[1],t.state=e[1].address_components[2]):(t.address=e[0].formatted_address,t.zip=e[0].address_components[0],t.city=e[0].address_components[1],t.state=e[0].address_components[2]),n(t.address)})})},e.geocode=function(r,s){return s||(i=0),n(function(n,s){o.geocode(r,function(o,c){"OVER_QUERY_LIMIT"===c?a>i?(console.log("api query limit. taking a nap."),t(function(){i++,n(e.geocode(r,!0))},1200)):(console.log("max retry"),s(new Error("over query limit: maximum retry attempts"))):o&&o.length?"OK"!==c?s(new Error(c)):n(o):s(new Error("no results"))})})}}]),angular.module("popmap").factory("maptabs",[function(){return{getTabs:function(){return{1:{heading:"POPs",content:"views/dashboard/map/tabs/pops.html"},2:{heading:"Conns",content:"views/dashboard/map/tabs/connections.html"},3:{heading:"Routes",content:"views/dashboard/map/tabs/routes.html"}}}}}]),angular.module("popmap").factory("dijkstras",[function(){var n=function(){this._nodes=[],this.enqueue=function(n,t){this._nodes.push({key:t,priority:n}),this.sort()},this.dequeue=function(){return this._nodes.shift().key},this.sort=function(){this._nodes.sort(function(n,t){return n.priority-t.priority})},this.isEmpty=function(){return!this._nodes.length}},t=function(){var t=1/0;this.vertices={},this.addVertex=function(n,t){this.vertices[n]=t},this.shortestPath=function(e,o){var i,a,r,s,c=new n,l={},u={},d=[];for(a in this.vertices)a===e?(l[a]=0,c.enqueue(0,a)):(l[a]=t,c.enqueue(t,a)),u[a]=null;for(;!c.isEmpty();){if(i=c.dequeue(),i===o){for(;u[i];)d.push(i),i=u[i];break}if(i&&l[i]!==t)for(r in this.vertices[i])s=l[i]+this.vertices[i][r],s<l[r]&&(l[r]=s,u[r]=i,c.enqueue(s,r))}return d}};return t}]),angular.module("popmap").controller("LoginCtrl",["$scope","$location",function(n,t){var e="admin",o="password";n.submit=function(){return n.user==e&&n.password==o?t.path("/dashboard"):n.showForgot=!0,!1},n.demoLogin=function(){alert('Demo: "admin"/"password"'),n.user=e,n.password=o}}]),angular.module("popmap").controller("DashboardCtrl",["$scope","$state",function(n,t){n.$state=t}]),angular.module("popmap").controller("EditCtrl",["$scope","$state","pops",function(n,t,e){n.$state=t,e.getPops().then(function(t){n.pops=t,e.getConnections().then(function(t){n.connections=t})})}]),angular.module("popmap").controller("EditPopCtrl",["$scope","$stateParams","$timeout","$location","pops","geocoder",function(n,t,e,o,i,a){n.id=t.id,n.consoleMsg=null,i.getPop(t.id).then(function(t){n.pop=t,n.pop.address&&n.centerToAddress()}),n.centerToAddress=function(){n.pop&&n.pop.address&&n.map&&a.getLocation(n.pop.address).then(function(t){n.map.setCenter(t)})},n.savePop=function(){n.id||(n.id=n.pop["short"].toLowerCase().replace(/ /g,"-")),n.pop.id=n.id,i.savePop(n.id,n.pop).then(function(t){n.centerToAddress(),n.consoleMsg="saved!",e(function(){n.consoleMsg=null},3e3)})},n.deletePop=function(){n.id&&i.deletePop(n.id).then(function(){n.consoleMsg="deleted!",e(function(){n.consoleMsg=null},3e3),o.path("dashboard/edit")})},n.$watch("pop.color",function(){n.pop&&n.pop.color&&"#"==n.pop.color[0]&&(n.pop.color=n.pop.color.slice(1))},!0),n.$watch("pop.address",n.centerToAddress,!0),n.$watch("map",function(t){n.map||(n.map=t)})}]),angular.module("popmap").controller("EditConnectionCtrl",["$scope","$stateParams","$timeout","$location","pops",function(n,t,e,o,i){n.id=t.id,n.refresh=function(){i.getPops().then(function(t){n.pops=t,i.getConnection(n.id).then(function(t){n.connection=t,n.startId=t.start.id,n.finishId=t.finish.id})})},n.refresh(),n.saveConnection=function(){n.id||(n.id=n.startId+"-"+n.finishId),i.saveConnection(n.id,n.startId,n.finishId).then(function(t){n.consoleMsg="saved!",e(function(){n.consoleMsg=null},3e3),o.path("dashboard/edit/connection/"+t[0]+"-"+t[1])})},n.deleteConnection=function(){n.id&&i.deleteConnection(n.id).then(function(){n.consoleMsg="deleted!",e(function(){n.consoleMsg=null},3e3),o.path("dashboard/edit")})}}]),angular.module("popmap").controller("MapCtrl",["$scope","$q","$timeout","$window","pops","geocoder","dijkstras","maptabs",function(n,t,e,o,i,a,r,s){i.getPops().then(function(t){n.pops=t}),i.getConnections().then(function(t){n.connections=t}),n.maptabs=s.getTabs(),n.routeLineOpts={color:"#e21b24",weight:4,opacity:1},n.defaultColor="e6595d",o.innerWidth>480?(n.mapZoom=3,n.smallScreen=!1):(n.mapZoom=2,n.smallScreen=!0),n.$watch("map",function(t){n.originalCenter=t.getCenter(),n.originalZoom=t.getZoom(),n.addMarkerListener=google.maps.event.addListener(n.map,"click",function(t){n.addMarkers()})}),n.toggleBounce=function(){this.setAnimation(null!=this.getAnimation()?null:google.maps.Animation.BOUNCE)},n.addMarkers=function(){if(!n.markersDrop){n.markersDrop=!0,google.maps.event.removeListener(n.addMarkerListener);var o=t.all(null);n.displayLocations=[],angular.forEach(n.pops,function(i,a){i.id=i.id||a,o=o.then(function(){return t(function(t){return n.getPopLocation(i).then(function(o){return o.pop=i,e(function(){return n.markLocation(o,{title:i.name,label:i.id,icon:"http://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=%E2%80%A2|"+i.color}).then(function(e){o.marker=e,n.displayLocations.push(o),t(e)})},250)})})})}),o.then(function(){return e(function(){n.markersDropped=!0,n.showConnectButton=!0,n.connectMarkersListener=google.maps.event.addListener(n.map,"click",function(t){n.connectMarkers()})},500)})}},n.connectMarkers=function(){if(n.showConnectButton=!1,n.showConnections=!0,n.maptabs[1].active=!1,n.maptabs[2].active=!0,n.maptabs[3].active=!1,n.markersDropped&&!n.markersConnect){n.markersConnect=!0,google.maps.event.removeListener(n.connectMarkerListener);var o=t.all(null);return n.displayConnections=[],angular.forEach(n.connections,function(i,a){i.id=a,i.start.connections||(i.start.connections={}),i.finish.connections||(i.finish.connections={}),o=o.then(function(){return t(function(t){return n.getPopLocation(i.start).then(function(o){return n.getPopLocation(i.finish).then(function(a){return e(function(){return n.drawLine(o,a).then(function(e){i.line=e,i.displayMiles=Math.round(e.distance.miles),i.start.connections[i.id]=i,i.finish.connections[i.id]=i,n.displayConnections.push(i),t(e)})},250)})})})})}),o.then(function(){return n.markersConnected=!0,n.initForm(),o})}},n.getLocationAddress=function(n){return t(function(t,e){n.address?t(n.address):a.getAddress(n).then(function(n){t(n)})})},n.getPopLocation=function(e){return t(function(t,o){e.location?t(e.location):(n.retry=0,n.getAddressLocation(e.address).then(function(n){e.location=n,t(e.location)}))})},n.getClickedLocation=function(e){return t(function(t){var o=e.latLng;n.getLocationAddress(o).then(function(n){o.address=n,t(o)})})},n.getAddressLocation=function(n){return t(function(t,e){a.getLocation(n).then(function(n){t(n)})})},n.markLocation=function(e,o){if(!o)var o={};return t(function(t){t(new google.maps.Marker({position:e,map:n.map,draggable:o.draggable||!1,animation:google.maps.Animation.DROP,title:o.title||null,label:o.label||null,icon:o.icon||null}))})},n.drawLine=function(e,o,i){if(!i)var i={};return t(function(t){var a=new google.maps.Polyline({strokeColor:i.color||"#333333",strokeOpacity:i.opacity||.7,strokeWeight:i.weight||2,map:n.map}),r=a.getPath();r.push(e),r.push(o),n.getDistance(e,o).then(function(e){a.distance=n.convertDistanceFromMeters(e),t(a)})})},n.convertDistanceFromMeters=function(n){return{meters:n,kilometers:n/1e3,miles:621371e-9*n}},n.getDistance=function(n,e){return t(function(t,o){var i=google.maps.geometry.spherical.computeDistanceBetween(n,e);t(i)})},n.getClosestPop=function(e){var o={},i=-1,a=t.all(null);return angular.forEach(n.pops,function(r,s){a=a.then(function(){return t(function(t){return n.getDistance(e,r.location).then(function(e){var a=n.convertDistanceFromMeters(e);o[s]=a,(-1==i||a.meters<o[i].meters)&&(i=s),t()})})})}),a.then(function(){return t(function(t){var e=n.pops[i];e.id=i,t(e)})})},n.markClient=function(t){n.client.location=t,n.clientMark=!0,n.maptabs[1].active=!1,n.maptabs[2].active=!1,n.maptabs[3].active=!0,n.unWatchClient&&n.unWatchClient(),n.showClientInput=!1,n.showServerInput=!0,google.maps.event.removeListener(n.clientMarkListener),n.map.setCenter(t),n.markLocation(t,{title:t.address}).then(function(e){n.client.marker=e,n.map.setZoom(n.originalZoom+2),n.getClosestPop(t).then(function(t){n.closestPop=t,n.pathLines=[],n.drawLine(n.client.location,n.closestPop.location,n.routeLineOpts).then(function(t){n.client.location.pop={name:n.client.location.city?n.client.location.city.long_name||n.client.location.city:n.client.location.asTyped,"short":n.client.location.city?n.client.location.city.short_name||n.client.location.city:n.client.location.asTyped,color:n.defaultColor},t.start=n.client.location,t.finish=n.closestPop.location,n.pathLines.push(t),n.clientMarked=!0,n.setServer(n.closestPop.id),n.popListeners={},angular.forEach(n.pops,function(t,e){var o=t.location.marker;n.popListeners[e]=o.addListener("click",function(){n.setServer(e)})})})})})},n.setServer=function(t){n.serverId=t,n.map.setZoom(n.originalZoom),n.map.setCenter(n.originalCenter),n.clearPathLines().then(function(){return n.drawLine(n.client.location,n.closestPop.location,n.routeLineOpts).then(function(e){return e.start=n.client.location,e.finish=n.closestPop.location,n.pathLines.push(e),n.clientMarked=!0,n.server=n.pops[t],n.server.id=t,n.routeDestination(n.closestPop,n.server).then(function(t){return n.connectRoute(t).then(function(t){return n.totalMiles=Math.round(t),!0})})})})},n.routeDestination=function(e,o){return t(function(i){var a=new r,s=t.all(null);return angular.forEach(n.pops,function(n,e){s=s.then(function(){return t(function(o){var i={},r=t.all(null);return angular.forEach(n.connections,function(t,e){var o=null;t.start.id==n.id?o=t.finish.id:t.finish.id==n.id&&(o=t.start.id),i[o]=t.line.distance.miles}),r.then(function(){a.addVertex(e,i),o()})})})}),s.then(function(){var n=a.shortestPath(e.id,o.id).concat([e.id]).reverse();i(n)})})},n.connectRoute=function(o){var i=t.all(null);n.pathLines=n.pathLines||[];var a=o[0];return angular.forEach(o,function(o,r){i=i.then(function(){return t(function(t){if(r>0){var i=n.pops[a].location;i.id=a;var s=n.pops[o].location;return s.id=o,e(function(){return n.drawLine(i,s,n.routeLineOpts).then(function(e){e.start=i,e.finish=s,e.displayMiles=Math.round(e.distance.miles),n.pathLines.push(e),a=o,t()})},250)}a=o,t()})})}),i.then(function(){n.pathLines[0].displayMiles=Math.round(n.pathLines[0].distance.miles);var e=0,o=t.all(null);return angular.forEach(n.pathLines,function(n){o=o.then(function(){return t(function(t){e+=n.distance.miles,t()})})}),o.then(function(){return t(function(t){n.totalMiles=e,t(e)})})})},n.clearPathLines=function(){var e=t.all(null);return angular.forEach(n.pathLines,function(n){e=e.then(function(){n.setMap(null)})}),e.then(function(){n.pathLines=[]})},n.initForm=function(){n.client&&n.client.marker&&n.client.marker.setMap(null),n.unWatchClient&&n.unWatchClient(),n.popListeners&&angular.forEach(n.popListeners,function(n){google.maps.event.removeListener(n)}),n.client={},n.server={},delete n.serverId,delete n.closestPop,n.showClientInput=!0,n.showServerInput=!1,n.clearPathLines().then(function(){n.map.setZoom(n.originalZoom),n.map.setCenter(n.originalCenter),n.clientMarkListener=google.maps.event.addListener(n.map,"click",function(t){n.getClickedLocation(t).then(n.markClient)}),n.unWatchClient=n.$watch("client.address",function(t){n.getAddressLocation(t).then(n.markClient)})})}}]);